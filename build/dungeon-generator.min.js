/**
 * almond 0.2.5 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

//     Underscore.js 1.4.4
//     http://underscorejs.org
//     (c) 2009-2013 Jeremy Ashkenas, DocumentCloud Inc.
//     Underscore may be freely distributed under the MIT license.

/* 
  ===========================================================================

  dungCarv

  ===========================================================================

  Copyright 2009 Łukasz Jasiński
 
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
 
  http://www.apache.org/licenses/LICENSE-2.0
 
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  ===========================================================================

  For minified version check dungCarv.min.js file.

  ===========================================================================
*/

(function(t,n){"function"==typeof define&&define.amd?define(n):t.VAPI.CannonApp=n()})(this,function(){var t,n,e;return function(r){function i(t,n){return T.call(t,n)}function u(t,n){var e,r,i,u,a,s,o,c,l,f,h=n&&n.split("/"),p=y.map,d=p&&p["*"]||{};if(t&&"."===t.charAt(0))if(n){for(h=h.slice(0,h.length-1),t=h.concat(t.split("/")),c=0;t.length>c;c+=1)if(f=t[c],"."===f)t.splice(c,1),c-=1;else if(".."===f){if(1===c&&(".."===t[2]||".."===t[0]))break;c>0&&(t.splice(c-1,2),c-=2)}t=t.join("/")}else 0===t.indexOf("./")&&(t=t.substring(2));if((h||d)&&p){for(e=t.split("/"),c=e.length;c>0;c-=1){if(r=e.slice(0,c).join("/"),h)for(l=h.length;l>0;l-=1)if(i=p[h.slice(0,l).join("/")],i&&(i=i[r])){u=i,a=c;break}if(u)break;!s&&d&&d[r]&&(s=d[r],o=c)}!u&&s&&(u=s,a=o),u&&(e.splice(0,a,u),t=e.join("/"))}return t}function a(t,n){return function(){return p.apply(r,O.call(arguments,0).concat([t,n]))}}function s(t){return function(n){return u(n,t)}}function o(t){return function(n){m[t]=n}}function c(t){if(i(g,t)){var n=g[t];delete g[t],_[t]=!0,h.apply(r,n)}if(!i(m,t)&&!i(_,t))throw Error("No "+t);return m[t]}function l(t){var n,e=t?t.indexOf("!"):-1;return e>-1&&(n=t.substring(0,e),t=t.substring(e+1,t.length)),[n,t]}function f(t){return function(){return y&&y.config&&y.config[t]||{}}}var h,p,d,v,m={},g={},y={},_={},T=Object.prototype.hasOwnProperty,O=[].slice;d=function(t,n){var e,r=l(t),i=r[0];return t=r[1],i&&(i=u(i,n),e=c(i)),i?t=e&&e.normalize?e.normalize(t,s(n)):u(t,n):(t=u(t,n),r=l(t),i=r[0],t=r[1],i&&(e=c(i))),{f:i?i+"!"+t:t,n:t,pr:i,p:e}},v={require:function(t){return a(t)},exports:function(t){var n=m[t];return n!==void 0?n:m[t]={}},module:function(t){return{id:t,uri:"",exports:m[t],config:f(t)}}},h=function(t,n,e,u){var s,l,f,h,p,y,T=[];if(u=u||t,"function"==typeof e){for(n=!n.length&&e.length?["require","exports","module"]:n,p=0;n.length>p;p+=1)if(h=d(n[p],u),l=h.f,"require"===l)T[p]=v.require(t);else if("exports"===l)T[p]=v.exports(t),y=!0;else if("module"===l)s=T[p]=v.module(t);else if(i(m,l)||i(g,l)||i(_,l))T[p]=c(l);else{if(!h.p)throw Error(t+" missing "+l);h.p.load(h.n,a(u,!0),o(l),{}),T[p]=m[l]}f=e.apply(m[t],T),t&&(s&&s.exports!==r&&s.exports!==m[t]?m[t]=s.exports:f===r&&y||(m[t]=f))}else t&&(m[t]=e)},t=n=p=function(t,n,e,i,u){return"string"==typeof t?v[t]?v[t](n):c(d(t,n).f):(t.splice||(y=t,n.splice?(t=n,n=e,e=null):t=r),n=n||function(){},"function"==typeof e&&(e=i,i=u),i?h(r,t,n,e):setTimeout(function(){h(r,t,n,e)},4),p)},p.config=function(t){return y=t,y.deps&&p(y.deps,y.callback),p},e=function(t,n,e){n.splice||(e=n,n=[]),i(m,t)||i(g,t)||(g[t]=[t,n,e])},e.amd={jQuery:!0}}(),e("vendor/almond",function(){}),function(){var t=this,n=t._,r={},i=Array.prototype,u=Object.prototype,a=Function.prototype,s=i.push,o=i.slice,c=i.concat,l=u.toString,f=u.hasOwnProperty,h=i.forEach,p=i.map,d=i.reduce,v=i.reduceRight,m=i.filter,g=i.every,y=i.some,_=i.indexOf,T=i.lastIndexOf,O=Array.isArray,x=Object.keys,R=a.bind,I=function(t){return t instanceof I?t:this instanceof I?(this._wrapped=t,void 0):new I(t)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=I),exports._=I):t._=I,I.VERSION="1.4.4";var D=I.each=I.forEach=function(t,n,e){if(null!=t)if(h&&t.forEach===h)t.forEach(n,e);else if(t.length===+t.length){for(var i=0,u=t.length;u>i;i++)if(n.call(e,t[i],i,t)===r)return}else for(var a in t)if(I.has(t,a)&&n.call(e,t[a],a,t)===r)return};I.map=I.collect=function(t,n,e){var r=[];return null==t?r:p&&t.map===p?t.map(n,e):(D(t,function(t,i,u){r[r.length]=n.call(e,t,i,u)}),r)};var E="Reduce of empty array with no initial value";I.reduce=I.foldl=I.inject=function(t,n,e,r){var i=arguments.length>2;if(null==t&&(t=[]),d&&t.reduce===d)return r&&(n=I.bind(n,r)),i?t.reduce(n,e):t.reduce(n);if(D(t,function(t,u,a){i?e=n.call(r,e,t,u,a):(e=t,i=!0)}),!i)throw new TypeError(E);return e},I.reduceRight=I.foldr=function(t,n,e,r){var i=arguments.length>2;if(null==t&&(t=[]),v&&t.reduceRight===v)return r&&(n=I.bind(n,r)),i?t.reduceRight(n,e):t.reduceRight(n);var u=t.length;if(u!==+u){var a=I.keys(t);u=a.length}if(D(t,function(s,o,c){o=a?a[--u]:--u,i?e=n.call(r,e,t[o],o,c):(e=t[o],i=!0)}),!i)throw new TypeError(E);return e},I.find=I.detect=function(t,n,e){var r;return L(t,function(t,i,u){return n.call(e,t,i,u)?(r=t,!0):void 0}),r},I.filter=I.select=function(t,n,e){var r=[];return null==t?r:m&&t.filter===m?t.filter(n,e):(D(t,function(t,i,u){n.call(e,t,i,u)&&(r[r.length]=t)}),r)},I.reject=function(t,n,e){return I.filter(t,function(t,r,i){return!n.call(e,t,r,i)},e)},I.every=I.all=function(t,n,e){n||(n=I.identity);var i=!0;return null==t?i:g&&t.every===g?t.every(n,e):(D(t,function(t,u,a){return(i=i&&n.call(e,t,u,a))?void 0:r}),!!i)};var L=I.some=I.any=function(t,n,e){n||(n=I.identity);var i=!1;return null==t?i:y&&t.some===y?t.some(n,e):(D(t,function(t,u,a){return i||(i=n.call(e,t,u,a))?r:void 0}),!!i)};I.contains=I.include=function(t,n){return null==t?!1:_&&t.indexOf===_?-1!=t.indexOf(n):L(t,function(t){return t===n})},I.invoke=function(t,n){var e=o.call(arguments,2),r=I.isFunction(n);return I.map(t,function(t){return(r?n:t[n]).apply(t,e)})},I.pluck=function(t,n){return I.map(t,function(t){return t[n]})},I.where=function(t,n,e){return I.isEmpty(n)?e?null:[]:I[e?"find":"filter"](t,function(t){for(var e in n)if(n[e]!==t[e])return!1;return!0})},I.findWhere=function(t,n){return I.where(t,n,!0)},I.max=function(t,n,e){if(!n&&I.isArray(t)&&t[0]===+t[0]&&65535>t.length)return Math.max.apply(Math,t);if(!n&&I.isEmpty(t))return-1/0;var r={computed:-1/0,value:-1/0};return D(t,function(t,i,u){var a=n?n.call(e,t,i,u):t;a>=r.computed&&(r={value:t,computed:a})}),r.value},I.min=function(t,n,e){if(!n&&I.isArray(t)&&t[0]===+t[0]&&65535>t.length)return Math.min.apply(Math,t);if(!n&&I.isEmpty(t))return 1/0;var r={computed:1/0,value:1/0};return D(t,function(t,i,u){var a=n?n.call(e,t,i,u):t;r.computed>a&&(r={value:t,computed:a})}),r.value},I.shuffle=function(t){var n,e=0,r=[];return D(t,function(t){n=I.random(e++),r[e-1]=r[n],r[n]=t}),r};var b=function(t){return I.isFunction(t)?t:function(n){return n[t]}};I.sortBy=function(t,n,e){var r=b(n);return I.pluck(I.map(t,function(t,n,i){return{value:t,index:n,criteria:r.call(e,t,n,i)}}).sort(function(t,n){var e=t.criteria,r=n.criteria;if(e!==r){if(e>r||void 0===e)return 1;if(r>e||void 0===r)return-1}return t.index<n.index?-1:1}),"value")};var N=function(t,n,e,r){var i={},u=b(n||I.identity);return D(t,function(n,a){var s=u.call(e,n,a,t);r(i,s,n)}),i};I.groupBy=function(t,n,e){return N(t,n,e,function(t,n,e){(I.has(t,n)?t[n]:t[n]=[]).push(e)})},I.countBy=function(t,n,e){return N(t,n,e,function(t,n){I.has(t,n)||(t[n]=0),t[n]++})},I.sortedIndex=function(t,n,e,r){e=null==e?I.identity:b(e);for(var i=e.call(r,n),u=0,a=t.length;a>u;){var s=u+a>>>1;i>e.call(r,t[s])?u=s+1:a=s}return u},I.toArray=function(t){return t?I.isArray(t)?o.call(t):t.length===+t.length?I.map(t,I.identity):I.values(t):[]},I.size=function(t){return null==t?0:t.length===+t.length?t.length:I.keys(t).length},I.first=I.head=I.take=function(t,n,e){return null==t?void 0:null==n||e?t[0]:o.call(t,0,n)},I.initial=function(t,n,e){return o.call(t,0,t.length-(null==n||e?1:n))},I.last=function(t,n,e){return null==t?void 0:null==n||e?t[t.length-1]:o.call(t,Math.max(t.length-n,0))},I.rest=I.tail=I.drop=function(t,n,e){return o.call(t,null==n||e?1:n)},I.compact=function(t){return I.filter(t,I.identity)};var A=function(t,n,e){return D(t,function(t){I.isArray(t)?n?s.apply(e,t):A(t,n,e):e.push(t)}),e};I.flatten=function(t,n){return A(t,n,[])},I.without=function(t){return I.difference(t,o.call(arguments,1))},I.uniq=I.unique=function(t,n,e,r){I.isFunction(n)&&(r=e,e=n,n=!1);var i=e?I.map(t,e,r):t,u=[],a=[];return D(i,function(e,r){(n?r&&a[a.length-1]===e:I.contains(a,e))||(a.push(e),u.push(t[r]))}),u},I.union=function(){return I.uniq(c.apply(i,arguments))},I.intersection=function(t){var n=o.call(arguments,1);return I.filter(I.uniq(t),function(t){return I.every(n,function(n){return I.indexOf(n,t)>=0})})},I.difference=function(t){var n=c.apply(i,o.call(arguments,1));return I.filter(t,function(t){return!I.contains(n,t)})},I.zip=function(){for(var t=o.call(arguments),n=I.max(I.pluck(t,"length")),e=Array(n),r=0;n>r;r++)e[r]=I.pluck(t,""+r);return e},I.object=function(t,n){if(null==t)return{};for(var e={},r=0,i=t.length;i>r;r++)n?e[t[r]]=n[r]:e[t[r][0]]=t[r][1];return e},I.indexOf=function(t,n,e){if(null==t)return-1;var r=0,i=t.length;if(e){if("number"!=typeof e)return r=I.sortedIndex(t,n),t[r]===n?r:-1;r=0>e?Math.max(0,i+e):e}if(_&&t.indexOf===_)return t.indexOf(n,e);for(;i>r;r++)if(t[r]===n)return r;return-1},I.lastIndexOf=function(t,n,e){if(null==t)return-1;var r=null!=e;if(T&&t.lastIndexOf===T)return r?t.lastIndexOf(n,e):t.lastIndexOf(n);for(var i=r?e:t.length;i--;)if(t[i]===n)return i;return-1},I.range=function(t,n,e){1>=arguments.length&&(n=t||0,t=0),e=arguments[2]||1;for(var r=Math.max(Math.ceil((n-t)/e),0),i=0,u=Array(r);r>i;)u[i++]=t,t+=e;return u},I.bind=function(t,n){if(t.bind===R&&R)return R.apply(t,o.call(arguments,1));var e=o.call(arguments,2);return function(){return t.apply(n,e.concat(o.call(arguments)))}},I.partial=function(t){var n=o.call(arguments,1);return function(){return t.apply(this,n.concat(o.call(arguments)))}},I.bindAll=function(t){var n=o.call(arguments,1);return 0===n.length&&(n=I.functions(t)),D(n,function(n){t[n]=I.bind(t[n],t)}),t},I.memoize=function(t,n){var e={};return n||(n=I.identity),function(){var r=n.apply(this,arguments);return I.has(e,r)?e[r]:e[r]=t.apply(this,arguments)}},I.delay=function(t,n){var e=o.call(arguments,2);return setTimeout(function(){return t.apply(null,e)},n)},I.defer=function(t){return I.delay.apply(I,[t,1].concat(o.call(arguments,1)))},I.throttle=function(t,n){var e,r,i,u,a=0,s=function(){a=new Date,i=null,u=t.apply(e,r)};return function(){var o=new Date,c=n-(o-a);return e=this,r=arguments,0>=c?(clearTimeout(i),i=null,a=o,u=t.apply(e,r)):i||(i=setTimeout(s,c)),u}},I.debounce=function(t,n,e){var r,i;return function(){var u=this,a=arguments,s=function(){r=null,e||(i=t.apply(u,a))},o=e&&!r;return clearTimeout(r),r=setTimeout(s,n),o&&(i=t.apply(u,a)),i}},I.once=function(t){var n,e=!1;return function(){return e?n:(e=!0,n=t.apply(this,arguments),t=null,n)}},I.wrap=function(t,n){return function(){var e=[t];return s.apply(e,arguments),n.apply(this,e)}},I.compose=function(){var t=arguments;return function(){for(var n=arguments,e=t.length-1;e>=0;e--)n=[t[e].apply(this,n)];return n[0]}},I.after=function(t,n){return 0>=t?n():function(){return 1>--t?n.apply(this,arguments):void 0}},I.keys=x||function(t){if(t!==Object(t))throw new TypeError("Invalid object");var n=[];for(var e in t)I.has(t,e)&&(n[n.length]=e);return n},I.values=function(t){var n=[];for(var e in t)I.has(t,e)&&n.push(t[e]);return n},I.pairs=function(t){var n=[];for(var e in t)I.has(t,e)&&n.push([e,t[e]]);return n},I.invert=function(t){var n={};for(var e in t)I.has(t,e)&&(n[t[e]]=e);return n},I.functions=I.methods=function(t){var n=[];for(var e in t)I.isFunction(t[e])&&n.push(e);return n.sort()},I.extend=function(t){return D(o.call(arguments,1),function(n){if(n)for(var e in n)t[e]=n[e]}),t},I.pick=function(t){var n={},e=c.apply(i,o.call(arguments,1));return D(e,function(e){e in t&&(n[e]=t[e])}),n},I.omit=function(t){var n={},e=c.apply(i,o.call(arguments,1));for(var r in t)I.contains(e,r)||(n[r]=t[r]);return n},I.defaults=function(t){return D(o.call(arguments,1),function(n){if(n)for(var e in n)null==t[e]&&(t[e]=n[e])}),t},I.clone=function(t){return I.isObject(t)?I.isArray(t)?t.slice():I.extend({},t):t},I.tap=function(t,n){return n(t),t};var B=function(t,n,e,r){if(t===n)return 0!==t||1/t==1/n;if(null==t||null==n)return t===n;t instanceof I&&(t=t._wrapped),n instanceof I&&(n=n._wrapped);var i=l.call(t);if(i!=l.call(n))return!1;switch(i){case"[object String]":return t==n+"";case"[object Number]":return t!=+t?n!=+n:0==t?1/t==1/n:t==+n;case"[object Date]":case"[object Boolean]":return+t==+n;case"[object RegExp]":return t.source==n.source&&t.global==n.global&&t.multiline==n.multiline&&t.ignoreCase==n.ignoreCase}if("object"!=typeof t||"object"!=typeof n)return!1;for(var u=e.length;u--;)if(e[u]==t)return r[u]==n;e.push(t),r.push(n);var a=0,s=!0;if("[object Array]"==i){if(a=t.length,s=a==n.length)for(;a--&&(s=B(t[a],n[a],e,r)););}else{var o=t.constructor,c=n.constructor;if(o!==c&&!(I.isFunction(o)&&o instanceof o&&I.isFunction(c)&&c instanceof c))return!1;for(var f in t)if(I.has(t,f)&&(a++,!(s=I.has(n,f)&&B(t[f],n[f],e,r))))break;if(s){for(f in n)if(I.has(n,f)&&!a--)break;s=!a}}return e.pop(),r.pop(),s};I.isEqual=function(t,n){return B(t,n,[],[])},I.isEmpty=function(t){if(null==t)return!0;if(I.isArray(t)||I.isString(t))return 0===t.length;for(var n in t)if(I.has(t,n))return!1;return!0},I.isElement=function(t){return!(!t||1!==t.nodeType)},I.isArray=O||function(t){return"[object Array]"==l.call(t)},I.isObject=function(t){return t===Object(t)},D(["Arguments","Function","String","Number","Date","RegExp"],function(t){I["is"+t]=function(n){return l.call(n)=="[object "+t+"]"}}),I.isArguments(arguments)||(I.isArguments=function(t){return!(!t||!I.has(t,"callee"))}),I.isFunction=function(t){return"function"==typeof t},I.isFinite=function(t){return isFinite(t)&&!isNaN(parseFloat(t))},I.isNaN=function(t){return I.isNumber(t)&&t!=+t},I.isBoolean=function(t){return t===!0||t===!1||"[object Boolean]"==l.call(t)},I.isNull=function(t){return null===t},I.isUndefined=function(t){return void 0===t},I.has=function(t,n){return f.call(t,n)},I.noConflict=function(){return t._=n,this},I.identity=function(t){return t},I.times=function(t,n,e){for(var r=Array(t),i=0;t>i;i++)r[i]=n.call(e,i);return r},I.random=function(t,n){return null==n&&(n=t,t=0),t+Math.floor(Math.random()*(n-t+1))};var M={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};M.unescape=I.invert(M.escape);var j={escape:RegExp("["+I.keys(M.escape).join("")+"]","g"),unescape:RegExp("("+I.keys(M.unescape).join("|")+")","g")};I.each(["escape","unescape"],function(t){I[t]=function(n){return null==n?"":(""+n).replace(j[t],function(n){return M[t][n]})}}),I.result=function(t,n){if(null==t)return null;var e=t[n];return I.isFunction(e)?e.call(t):e},I.mixin=function(t){D(I.functions(t),function(n){var e=I[n]=t[n];I.prototype[n]=function(){var t=[this._wrapped];return s.apply(t,arguments),S.call(this,e.apply(I,t))}})};var w=0;I.uniqueId=function(t){var n=++w+"";return t?t+n:n},I.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var U=/(.)^/,k={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},F=/\\|'|\r|\n|\t|\u2028|\u2029/g;I.template=function(t,n,e){var r;e=I.defaults({},e,I.templateSettings);var i=RegExp([(e.escape||U).source,(e.interpolate||U).source,(e.evaluate||U).source].join("|")+"|$","g"),u=0,a="__p+='";t.replace(i,function(n,e,r,i,s){return a+=t.slice(u,s).replace(F,function(t){return"\\"+k[t]}),e&&(a+="'+\n((__t=("+e+"))==null?'':_.escape(__t))+\n'"),r&&(a+="'+\n((__t=("+r+"))==null?'':__t)+\n'"),i&&(a+="';\n"+i+"\n__p+='"),u=s+n.length,n}),a+="';\n",e.variable||(a="with(obj||{}){\n"+a+"}\n"),a="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{r=Function(e.variable||"obj","_",a)}catch(s){throw s.source=a,s}if(n)return r(n,I);var o=function(t){return r.call(this,t,I)};return o.source="function("+(e.variable||"obj")+"){\n"+a+"}",o},I.chain=function(t){return I(t).chain()};var S=function(t){return this._chain?I(t).chain():t};I.mixin(I),D(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var n=i[t];I.prototype[t]=function(){var e=this._wrapped;return n.apply(e,arguments),"shift"!=t&&"splice"!=t||0!==e.length||delete e[0],S.call(this,e)}}),D(["concat","join","slice"],function(t){var n=i[t];I.prototype[t]=function(){return S.call(this,n.apply(this._wrapped,arguments))}}),I.extend(I.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}}),"function"==typeof e&&e.amd&&e("underscore",[],function(){return I})}.call(this),e("dungcarv",[],function(){function t(t){return t.padding||(t.padding=1),t.randomness||(t.randomness=0),t.twistness||(t.twistness=0),t.loops||(t.loops=0),t.spaces||(t.spaces=0),t.loopSpaceRepeat||(t.loopSpaceRepeat=1),t.roomSize||(t.roomSize=[]),t.rooms&&0!=t.roomSize.length||(t.rooms=0),t.mapWidth&&t.mapHeight?{MAP_WIDTH:t.mapWidth,MAP_HEIGHT:t.mapHeight,TILE_WALL:0,TILE_CORRIDOR:1,TILE_ROOM:2,TILE_DOOR:3,TILE_ENTRANCE:4,TILE_EXIT:5,TILE_ROOM_TMP:9998,TILE_WALL_TMP:9999,BOUND_TOP:t.padding,BOUND_RIGHT:t.mapWidth-t.padding-1,BOUND_BOTTOM:t.mapHeight-t.padding-1,BOUND_LEFT:t.padding,DIR_NONE:0,DIR_UP:1,DIR_RIGHT:2,DIR_DOWN:3,DIR_LEFT:4,map:[],queue:[],success:!1,started:!1,finished:!1,dir:this.DIR_NONE,elem:null,create:function(){this.fill(this.TILE_WALL),this.generate(),t.loopSpaceRepeat>0&&t.spacesBeforeLoops&&t.spaces>0&&this.makeSpaces();for(var n=0;t.loopSpaceRepeat>n;n++)t.loops>0&&this.makeLoops(),t.spaces>0&&this.makeSpaces();return t.eraseRoomDeadEnds&&this.eraseRoomDeadEnds(),this.returnValue()},generate:function(){for(;!this.finished;)this.step()},step:function(){if(!this.started){var n,e;return t.entrance&&t.entrance.x&&t.entrance.y?(n=t.entrance.x,e=t.entrance.y):(n=Math.rnd(this.BOUND_LEFT,this.BOUND_RIGHT),e=Math.rnd(this.BOUND_TOP,this.BOUND_BOTTOM)),this.started=!0,this.queue.push({x:n,y:e}),this.set(n,e,this.TILE_ENTRANCE),void 0}if(this.elem&&this.queue.length>0&&Math.random()<t.randomness){var n=this.elem.x,e=this.elem.y;this.elem=this.queue.rnd(),this.queue.push({x:n,y:e})}if(!this.elem){if(0==this.queue.length)return this.finished=!0,void 0;this.elem=this.queue.rnd()}var r=this.avaibleDir(this.elem.x,this.elem.y);if(0==r.length)return this.elem=null,void 0;switch((-1==r.indexOf(this.dir)||Math.random()<t.twistness)&&(this.dir=r.rnd()),this.dir){case this.DIR_UP:this.elem.y--;break;case this.DIR_RIGHT:this.elem.x++;break;case this.DIR_DOWN:this.elem.y++;break;case this.DIR_LEFT:this.elem.x--}return Math.random()<t.rooms&&this.placeRoom(this.elem.x,this.elem.y,this.dir)?(this.queue.push({x:this.elem.x,y:this.elem.y}),this.elem=null,void 0):(this.set(this.elem.x,this.elem.y,this.TILE_CORRIDOR),this.queue.push({x:this.elem.x,y:this.elem.y}),void 0)},placeRoom:function(n,e,r){for(var i,u=Math.random(),a=0,s=-1,o=0;t.roomSize.length>o;o++)if(i=t.roomSize[o],a+=i.prob,a>u){s=o;break}if(-1==s)return!1;i=t.roomSize[s];var c=Math.rnd(i.min,i.max),l=Math.rnd(i.min,i.max),f=[],h={};switch(r){case this.DIR_UP:h={t:e-l,r:n,b:e-l,l:n-c+1};break;case this.DIR_RIGHT:h={t:e-l+1,r:n+1,b:e,l:n+1};break;case this.DIR_DOWN:h={t:e+1,r:n,b:e+1,l:n-c+1};break;case this.DIR_LEFT:h={t:e-l+1,r:n-c+1,b:e,l:n-c+1}}for(var p=h.l;h.r>=p;p++)for(var d=h.t;h.b>=d;d++){for(var v=!0,m=p-1;p+c>=m;m++)for(var g=d-1;d+l>=g;g++){if(!this.testTile(m,g,[this.TILE_WALL])){v=!1;break}if(!v)break}v&&f.push({x:p,y:d})}if(0==f.length)return!1;this.set(n,e,this.TILE_CORRIDOR);for(var y=f.rnd(),m=y.x;y.x+c>m;m++)for(var g=y.y;y.y+l>g;g++)this.set(m,g,this.TILE_ROOM_TMP);for(var m=y.x;y.x+c>m;m++)for(var g=y.y;y.y+l>g;g++)t.roomRound&&this.roundCorner(m,g,y.x,y.y,c,l)?this.set(m,g,this.TILE_WALL):((m==y.x||m==y.x+c-1||g==y.y||g==y.y+l-1)&&this.queue.push({x:m,y:g}),this.set(m,g,this.TILE_ROOM));return!0},roundCorner:function(){return!1},makeLoops:function(){for(var n=[],e=[],r=this.BOUND_LEFT;this.BOUND_RIGHT>=r;r++)for(var i=this.BOUND_TOP;this.BOUND_BOTTOM>=i;i++)e[this.xy(r,i)]=!0;for(var r=this.BOUND_LEFT;this.BOUND_RIGHT>=r;r++)for(var i=this.BOUND_TOP;this.BOUND_BOTTOM>=i;i++){var u=this.xy(r,i);if(this.testTile(r,i,[this.TILE_WALL]))e[u]=!1;else{var a=this.adjacent(r,i);if(1==a.length&&Math.random()<t.loops){var s=a.pop();e[u]=!1,e[this.xy(s.x,s.y)]=!1,n.push({x:r,y:i});var o=this.map[this.xy(s.x,s.y)];this.set(s.x,s.y,this.TILE_WALL);for(var c=this.diagonal(r,i),l=0;c.length>l;l++)e[this.xy(c[l].x,c[l].y)]=!1;this.set(s.x,s.y,o)}}}if(0!=n.length){for(var r=this.BOUND_LEFT;this.BOUND_RIGHT>=r;r++)for(var i=this.BOUND_TOP;this.BOUND_BOTTOM>=i;i++)e[this.xy(r,i)]&&this.queue.push({x:r,y:i});for(var l=0;n.length>l;l++)this.set(n[l].x,n[l].y,this.TILE_WALL_TMP);this.finished=!1,this.generate();for(var l=0;n.length>l;l++)this.set(n[l].x,n[l].y,this.TILE_CORRIDOR)}},makeSpaces:function(){for(var n=0;t.spaces>n;n++){for(var e=[],r=this.BOUND_LEFT;this.BOUND_RIGHT>=r;r++)for(var i=this.BOUND_TOP;this.BOUND_BOTTOM>=i;i++)if(this.testTile(r,i,[this.TILE_CORRIDOR])){var u=this.adjacent(r,i);1==u.length&&e.push({x:r,y:i})}for(var a=0;e.length>a;a++)this.set(e[a].x,e[a].y,this.TILE_WALL)}},eraseRoomDeadEnds:function(){for(var t=this.BOUND_LEFT;this.BOUND_RIGHT>=t;t++)for(var n=this.BOUND_TOP;this.BOUND_BOTTOM>=n;n++)if(this.testTile(t,n,[this.TILE_CORRIDOR])){var e=this.adjacent(t,n);1==e.length&&(this.testTile(e[0].x,e[0].y,[this.TILE_ROOM]),this.set(t,n,this.TILE_WALL))}},set:function(t,n,e){this.map[this.xy(t,n)]=e},xy:function(n,e){return n+e*t.mapWidth},avaibleDir:function(t,n){var e=[];return this.canCarve(t,n-1)&&e.push(this.DIR_UP),this.canCarve(t+1,n)&&e.push(this.DIR_RIGHT),this.canCarve(t,n+1)&&e.push(this.DIR_DOWN),this.canCarve(t-1,n)&&e.push(this.DIR_LEFT),e},canCarve:function(t,n){if(!this.testTile(t,n,[this.TILE_WALL]))return!1;var e=this.adjacent(t,n),r=this.diagonal(t,n);return 1!=e.length?!1:0!=r.length?!1:!0},adjacent:function(t,n){var e=[],r=[this.TILE_ROOM,this.TILE_CORRIDOR,this.TILE_ENTRANCE];return this.testTile(t,n-1,r)&&e.push({x:t,y:n-1}),this.testTile(t+1,n,r)&&e.push({x:t+1,y:n}),this.testTile(t,n+1,r)&&e.push({x:t,y:n+1}),this.testTile(t-1,n,r)&&e.push({x:t-1,y:n}),e},diagonal:function(t,n){var e=[],r=[this.TILE_WALL,this.TILE_WALL_TMP];return!this.testTile(t-1,n-1,r)&&this.testTile(t-1,n,r)&&this.testTile(t,n-1,r)&&e.push({x:t-1,y:n-1}),!this.testTile(t+1,n-1,r)&&this.testTile(t+1,n,r)&&this.testTile(t,n-1,r)&&e.push({x:t+1,y:n-1}),!this.testTile(t+1,n+1,r)&&this.testTile(t+1,n,r)&&this.testTile(t,n+1,r)&&e.push({x:t+1,y:n+1}),!this.testTile(t-1,n+1,r)&&this.testTile(t-1,n,r)&&this.testTile(t,n+1,r)&&e.push({x:t-1,y:n+1}),e},testTile:function(t,n,e){return this.BOUND_LEFT>t||t>this.BOUND_RIGHT?!1:this.BOUND_TOP>n||n>this.BOUND_BOTTOM?!1:-1!=e.indexOf(this.map[this.xy(t,n)])},returnValue:function(){this.success=!0;var n={success:this.success};return this.success&&(n.map=this.map,t.returnRoomData&&(n.roomData=this.generateRoomData()),t.returnDoorData&&(n.doorData=this.generateDoorData()),t.returnStatistics&&(n.statistics=this.generateStatistics())),n},fill:function(t){for(var n=this.xy,e=0;this.MAP_WIDTH>e;e++)for(var r=0;this.MAP_HEIGHT>r;r++)this.map[n(e,r)]=t}}.create():{success:!1}}return Array.prototype.rnd=function(){if(0==this.length)return null;var t=Math.floor(Math.random()*this.length);return this.splice(t,1).pop()},Math.rnd=function(t,n){return Math.floor(Math.random()*(n-t+1))+t},t}),e("dungeon_generator",["underscore","dungcarv"],function(t,n){var e=window.DungeonGenerator=function(t,n){if(!(t instanceof SceneAsset))throw Error("scene must be an instance of SceneAsset");this.opts=n||{}};return e.prototype.create=function(){var e=100,r=50,i=n({mapWidth:e,mapHeight:r,randomness:1});window.console.log("+"+t.map(t.range(e),function(t){return t%10}).join("")),t.each(t.range(r),function(n){var r=i.map.splice(0,e);window.console.log(n%10+t.map(r,function(t){return 0===t?"#":" "}).join(""))})},e}),n("dungeon_generator")});